name: Build Android APK
on: [workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Capacitor
        run: |
          npm install @capacitor/core @capacitor/cli @capacitor/android
          mkdir -p out
          touch out/index.html
          npx cap add android || true

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '21'

      - name: Download icon with retry
        run: |
          echo "Intentando descargar icono..."
          # Primero intentar con curl que es m√°s confiable
          curl -s -o icon.png https://raw.githubusercontent.com/simulatorf1/f1-manager-game/main/public/IMG_20260202_194732.PNG || echo "Curl fall√≥, probando wget..."
          # Si curl falla, intentar con wget
          wget --no-check-certificate -q https://raw.githubusercontent.com/simulatorf1/f1-manager-game/main/public/IMG_20260202_194732.PNG -O icon.png || echo "Ambos m√©todos fallaron"
          
          if [ -f "icon.png" ]; then
            echo "‚úÖ Icono descargado correctamente"
            ls -la icon.png
          else
            echo "‚ö†Ô∏è  No se pudo descargar, creando icono temporal"
            # Crear un icono temporal azul
            convert -size 512x512 xc:#2196F3 -fill white -draw 'circle 256,256 256,100' icon.png 2>/dev/null || echo "Icono temporal no creado"
          fi

      - name: Setup Android project
        run: |
          # Forzar sync de Capacitor
          npx cap sync android
          
          # Crear estructura m√≠nima si no existe
          mkdir -p android/app/src/main/res/values
          
          # Crear strings.xml con nombre de la app
          echo '<?xml version="1.0" encoding="utf-8"?>
<resources>
    <string name="app_name">Critical LAP</string>
</resources>' > android/app/src/main/res/values/strings.xml
          
          # Asegurar que el AndroidManifest tenga el nombre correcto
          if [ -f "android/app/src/main/AndroidManifest.xml" ]; then
            sed -i 's/android:label="[^"]*"/android:label="Critical LAP"/g' android/app/src/main/AndroidManifest.xml
            sed -i 's/android:label="[^"]*"/android:label="Critical LAP"/g' android/app/src/main/AndroidManifest.xml
          fi

      - name: Install dependencies for build
        run: |
          # Instalar lo necesario
          sudo apt-get update
          sudo apt-get install -y imagemagick || true
          
          # Si hay icono, crear versiones para Android
          if [ -f "icon.png" ]; then
            echo "Creando iconos para Android..."
            mkdir -p android/app/src/main/res/mipmap-mdpi
            mkdir -p android/app/src/main/res/mipmap-hdpi
            mkdir -p android/app/src/main/res/mipmap-xhdpi
            mkdir -p android/app/src/main/res/mipmap-xxhdpi
            mkdir -p android/app/src/main/res/mipmap-xxxhdpi
            
            # Crear iconos en diferentes tama√±os
            convert icon.png -resize 48x48 android/app/src/main/res/mipmap-mdpi/ic_launcher.png 2>/dev/null || true
            convert icon.png -resize 72x72 android/app/src/main/res/mipmap-hdpi/ic_launcher.png 2>/dev/null || true
            convert icon.png -resize 96x96 android/app/src/main/res/mipmap-xhdpi/ic_launcher.png 2>/dev/null || true
            convert icon.png -resize 144x144 android/app/src/main/res/mipmap-xxhdpi/ic_launcher.png 2>/dev/null || true
            convert icon.png -resize 192x192 android/app/src/main/res/mipmap-xxxhdpi/ic_launcher.png 2>/dev/null || true
          fi

      - name: Fix build configuration
        run: |
          cd android
          # Asegurar que gradlew es ejecutable
          chmod +x gradlew
          
          # A√±adir configuraci√≥n para evitar problemas
          echo "
android {
    defaultConfig {
        applicationId \"com.miweb.app\"
        minSdkVersion 22
        targetSdkVersion 34
        versionCode 1
        versionName \"1.0\"
    }
    
    buildTypes {
        debug {
            debuggable true
        }
    }
}

configurations.all {
    resolutionStrategy.eachDependency { DependencyResolveDetails details ->
        if (details.requested.group == 'org.jetbrains.kotlin') {
            details.useVersion '1.8.22'
        }
    }
}" >> app/build.gradle

      - name: Build APK
        run: |
          cd android
          ./gradlew assembleDebug --no-daemon --stacktrace
          
          # Verificar que se gener√≥ el APK
          if [ -f "app/build/outputs/apk/debug/app-debug.apk" ]; then
            echo "‚úÖ APK generado correctamente"
          else
            echo "‚ö†Ô∏è  Buscando APK en otras ubicaciones..."
            find . -name "*.apk" -type f
          fi

      - name: Prepare APK for upload
        run: |
          # Buscar el APK donde sea que est√©
          APK_PATH=$(find android -name "*.apk" -type f | grep -i debug | head -1)
          
          if [ -f "$APK_PATH" ]; then
            echo "‚úÖ APK encontrado en: $APK_PATH"
            # Crear directorio de salida
            mkdir -p android/app/build/outputs/apk/debug
            # Copiar y renombrar
            cp "$APK_PATH" android/app/build/outputs/apk/debug/CriticalLAP.apk
            
            # Comprimir
            cd android/app/build/outputs/apk/debug
            gzip -k CriticalLAP.apk
            echo "üì¶ APK listo: CriticalLAP.apk"
            echo "üìä Tama√±o: $(du -h CriticalLAP.apk | cut -f1)"
          else
            echo "‚ùå ERROR: No se encontr√≥ ning√∫n APK"
            exit 1
          fi

      - name: Upload APK (Compressed)
        uses: actions/upload-artifact@v4
        with:
          name: CriticalLAP-APK
          path: android/app/build/outputs/apk/debug/CriticalLAP.apk.gz
          retention-days: 7
          if-no-files-found: error

      - name: Upload APK (Original) as backup
        uses: actions/upload-artifact@v4
        with:
          name: CriticalLAP-APK-Original
          path: android/app/build/outputs/apk/debug/CriticalLAP.apk
          retention-days: 1

      - name: Display success message
        run: |
          echo "üéâ ¬°BUILD COMPLETADO CON √âXITO!"
          echo "üì± Nombre de la app: Critical LAP"
          echo "üéØ Icono: Configurado (IMG_20260202_194732.PNG)"
          echo "üì¶ Archivo APK: CriticalLAP.apk"
          echo "üì• Descarga desde: 'Artifacts' ‚Üí 'CriticalLAP-APK'"
          echo "üîß Instrucci√≥n: Descomprime el .gz antes de instalar"
